---
import cvEs from '../data/cv.json';
import cvEn from '../data/cv-en.json';
import { Briefcase, GraduationCap, ChevronDown } from 'lucide-react';
import { Icon } from 'astro-icon/components';
import { getIconName } from '../utils/icons';

interface ExperienceItem {
  type: string;
  company: string;
  position: string;
  period: string;
  description: string;
  details?: string[]; // La propiedad que falta
  tags?: { name: string; category: string }[];
}

const experienceEs = cvEs.experience as ExperienceItem[];
const experienceEn = cvEn.experience as ExperienceItem[];

const getDuration = (index: number) => {
  const durations = ["4 años y 1 mes", "1 año y 10 meses", "4 años y 1 mes"];
  return durations[index] || "";
}
---

<section id="trayectoria" class="py-10 px-4 md:px-6 transition-colors duration-300">
  <div class="max-w-5xl mx-auto bg-zinc-50 border border-zinc-200 dark:bg-zinc-900/40 dark:border-white/5 rounded-[3rem] p-6 md:p-16 relative overflow-hidden group shadow-sm dark:shadow-2xl">
    
    <div class="relative">
      <div class="flex items-center mb-12 justify-center">
        <h2 class="text-zinc-900 dark:text-white text-3xl font-bold uppercase tracking-tighter"
            data-es="Trayectoria" data-en="Timeline">
            Trayectoria
        </h2>
      </div>

      <div class="absolute left-4 md:left-1/2  h-[calc(100%-5rem)] md:h-[calc(100%-3rem)] w-px bg-zinc-300 dark:bg-white/10"></div>

      <div class="space-y-12 md:space-y-16">
        {experienceEs.map((item, index) => {
          const itemEn = experienceEn[index];
          const isEven = index % 2 === 0;
          const isWork = item.type === 'work';
          const colorClass = isWork ? 'fill-zinc-600 dark:fill-zinc-500' : 'fill-orange-500 dark:fill-orange-400';

          return (
            <div class={`relative flex flex-col md:flex-row items-center justify-between w-full ${isEven ? 'md:flex-row-reverse' : ''}`}>
              
              <div class="absolute left-4 md:left-1/2 -translate-x-1/2 z-20 flex items-center justify-center w-8 h-8 md:w-10 md:h-10 bg-white dark:bg-zinc-950 border border-zinc-300 dark:border-white/20 rounded-full shadow-sm">
                <span class="text-zinc-700 dark:text-zinc-200 scale-75 md:scale-100">
                  {isWork ? <Briefcase size={16} /> : <GraduationCap size={16} />}
                </span>
              </div>

              <div class="w-full pl-12 md:pl-0 md:w-[45%]">
                <div class="timeline-card group cursor-pointer bg-white dark:bg-[#0c0c0c] rounded-2xl shadow-md border border-zinc-200 dark:border-white/[0.08] transition-all duration-300 relative overflow-hidden">
                  
                  <div class="absolute top-0 left-0 h-7 md:h-8 flex items-start">
                    <svg width={isWork ? "190" : "140"} height="32" viewBox={isWork ? "0 0 190 32": "0 0 140 32"} class={colorClass}>
                      <polygon points={isWork ? "0,0 190,0 180,16 190,32 0,32": "0,0 140,0 130,16 140,32 0,32"} />
                    </svg>
                    <div class="absolute inset-0 flex items-center px-3 gap-1.5 text-white font-bold text-[9px] md:text-[10px] uppercase tracking-wider">
                      {isWork ? <Briefcase size={10} strokeWidth={3} /> : <GraduationCap size={10} strokeWidth={3} />}
                      <span data-es={isWork ? "Puesto de trabajo" : "Titulación"} data-en={isWork ? "Job Position" : "Education"}>
                        {isWork ? "Puesto de trabajo" : "Titulación"}
                      </span>
                    </div>
                  </div>

                  <div class="p-6 md:p-8 pt-10 md:pt-12">
                    <div class="flex justify-between items-start w-full">
                      <div class="w-full">
                        <div class="flex justify-between items-center gap-2">
                          <h3 class="text-lg md:text-xl font-bold text-zinc-900 dark:text-zinc-50 tracking-tight leading-tight">
                            {item.company}
                          </h3>
                          <ChevronDown size={18} className="text-zinc-400 dark:text-zinc-500 transition-transform duration-500 chevron-icon shrink-0" />
                        </div>

                        <p class="text-zinc-700 dark:text-zinc-300 font-semibold text-sm md:text-[17px] mt-1" data-es={item.position} data-en={itemEn.position}>
                          {item.position}
                        </p>
                        
                        <div class="text-zinc-600 dark:text-zinc-400 text-[11px] md:text-[13px] mt-2 font-medium italic">
                          <span class="not-italic block md:inline" data-es={item.period} data-en={itemEn.period}>{item.period}</span>
                          <span class="block md:inline md:ml-1 not-italic font-bold text-zinc-500 dark:text-zinc-500">({getDuration(index)})</span>
                        </div>
                      </div>
                    </div>

                    <div class="expand-container grid grid-rows-[0fr] transition-all duration-500 ease-in-out opacity-0 pointer-events-none">
                      <div class="overflow-hidden">
                        <div class="pt-4 mt-4 border-t border-zinc-100 dark:border-white/10">
                          <p class="text-zinc-700 dark:text-zinc-400 text-sm leading-relaxed mb-4" data-es={item.description} data-en={itemEn.description}>
                            {item.description}
                          </p>

                          {/* CAMBIO: Lista de detalles estilo imagen */}
                          {item.details && (
                            <ul class="mb-6 space-y-2">
                              {item.details.map((detail, i) => (
                                <li class="flex items-start gap-3 text-sm text-zinc-600 dark:text-zinc-400">
                                  <span class="text-cyan-600 dark:text-cyan-500 mt-1.5 shrink-0">•</span>
                                  <span data-es={detail} data-en={itemEn.details ? itemEn.details[i] : detail}>
                                    {detail}
                                  </span>
                                </li>
                              ))}
                            </ul>
                          )}
                          
                          {item.tags && (
                            <div class="flex flex-wrap gap-x-6 gap-y-4">
                              {item.tags.map((tag) => (
                                <div class="flex flex-col items-center gap-1.5 group/icon">
                                  <div class="p-2 rounded-lg bg-zinc-100 dark:bg-white/[0.05] border border-zinc-200 dark:border-white/10">
                                    <Icon name={getIconName(tag.name)} class="w-5 h-5 text-zinc-600 dark:text-zinc-400 group-hover/icon:text-cyan-600 dark:group-hover/icon:text-cyan-400 transition-colors" />
                                  </div>
                                  <span class="text-[9px] text-zinc-600 dark:text-zinc-400 font-bold uppercase tracking-tight">{tag.name}</span>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="hidden md:block w-[45%]"></div>
            </div>
          )
        })}
      </div>
    </div>
  </div>
</section>

<style>
  .timeline-card.is-expanded .expand-container {
    grid-template-rows: 1fr;
    opacity: 1;
    pointer-events: auto;
    margin-top: 0.5rem;
  }
  
  .timeline-card.is-expanded .chevron-icon {
    transform: rotate(180deg);
    color: #0891b2;
  }

  .timeline-card:hover {
    border-color: rgba(6, 182, 212, 0.4);
  }
</style>

<script>
  function setupTimeline() {
    const cards = document.querySelectorAll('.timeline-card');
    
    cards.forEach(card => {
      card.replaceWith(card.cloneNode(true));
    });

    const freshCards = document.querySelectorAll('.timeline-card');
    freshCards.forEach(freshCard => {
      freshCard.addEventListener('click', () => {
        freshCard.classList.toggle('is-expanded');
      });
    });

    const updateLang = () => {
      const lang = localStorage.getItem('lang') || 'es';
      document.querySelectorAll('#trayectoria [data-es]').forEach(el => {
        const text = el.getAttribute(`data-${lang}`);
        if (text) el.textContent = text;
      });
    };

    window.addEventListener('language-changed', updateLang);
    updateLang();
  }

  setupTimeline();
  document.addEventListener('astro:after-swap', setupTimeline);
</script>